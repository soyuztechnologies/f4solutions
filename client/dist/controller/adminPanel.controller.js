sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/json/JSONModel"],function(e,t,s,o,r){"use strict";return e.extend("oft.fiori.controller.adminPanel",{formatter:o,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.herculis,this);var e=this;var t=this.getModel("local").getProperty("/CurrentUser");var s=this.getModel("local").oData.AppUsers[t].UserName;s="Hey "+s;this.getView().byId("idUser").setText(s);debugger;e.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/AppUsers","GET",null,null,this).then(function(t){e.getView().setBusy(false)}).catch(function(t){var s=e.getErrorMessage(t)})},onPressSaveSecure:function(){var e=this;e.getView().byId("viewSecureTable").setBusy(true);var o=this.getView().getModel("local");var r=o.getData().appUsers;this.getView().getModel().setDeferredBatchGroups(["SaveSecureUserBatch"]);var a=function(e,t){return e.CredId===t.CredId};if(r.length>0){var i;for(var l=0;l<r.length;l++){delete r[l].CreateMode;if(r[l].SecureKey==="*******"){r[l].SecureKey=""}r[l].SecureKey=btoa(r[l].SecureKey);i=this.globalData.filter(a.bind(null,r[l]));if(i.length===1&&JSON.stringify(i[0])!==JSON.stringify(r[l])){this.getView().getModel().update("/SecureSet('"+r[l].CredId+"')",r[l],{groupId:"SaveSecureUserBatch"})}else if(r[l].CredId===undefined){this.getView().getModel().create("/SecureSet",r[l],{groupId:"SaveSecureUserBatch"})}}for(var n=0;n<this.globalData.length;n++){i=r.filter(a.bind(null,this.globalData[n]));if(i.length===0){this.getView().getModel().remove("/SecureSet('"+this.globalData[n].CredId+"')",{groupId:"SaveSecureUserBatch"})}}}else{for(var g=0;g<this.globalData.length;g++){this.getView().getModel().remove("/SecureSet('"+this.globalData[g].CredId+"')",{groupId:"SaveSecureUserBatch"})}}if(JSON.stringify(r)===JSON.stringify(this.globalData)){s.show(e.resourceBundle.getText("MSG_GET_SECURE_SAVE_ERROR"));e.getView().byId("viewSecureTable").setBusy(false);return}this.getView().getModel().submitChanges({batchGroupId:"SaveSecureUserBatch",success:function(o,r){var a=o.__batchResponses;e.getView().byId("viewSecureTable").setBusy(false);for(var i=0;i<a.length;i++){if(o.__batchResponses[i].response&&o.__batchResponses[i].response.statusCode>399&&o.__batchResponses[i].response.statusCode<600){t.error(JSON.parse(o.__batchResponses[i].response.body).error.message.value,{title:e.resourceBundle.getText("TIT_MESSAGE_BOX_ERR"),onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}}e._getSecureDetails();s.show(e.resourceBundle.getText("MSG_GET_SECURE_SAVE_SUCCESS"))},error:function(s){e.getView().byId("viewSecureTable").setBusy(false);t.error(e.getErrorMsg(s),{title:e.resourceBundle.getText("TIT_MESSAGE_BOX_ERR"),onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})},onPressDeleteSecureRow:function(){var e=this;var s=this.getView().byId("viewSecureTable").getSelectedContexts();var o=this.getView().getModel("local");var r=o.getData().appUsers;if(s.length<1){t.error("Select atlease one row",{title:"Selection Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}sap.m.MessageBox.confirm("Confirm deletion?",{title:"Confirmation",onClose:function(t){if(t===sap.m.MessageBox.Action.OK){var s=e.getView().byId("viewSecureTable").getSelectedContexts();for(var r=0;r<s["length"];r++){e.ODataHelper.callOData(e.getOwnerComponent().getModel(),s[r].sPath,"DELETE",{},{},e).then(function(e){sap.m.MessageToast.show("Deleted succesfully")}).catch(function(t){e.getView().setBusy(false);e.oPopover=e.getErrorMessage(t);e.getView().setBusy(false)})}o.updateBindings();e.getView().byId("viewSecureTable").removeSelections()}}})},onPressHandleSecureOkPopup:function(e){var t=this;var s=e.getSource().getParent().getContent()[0].getBindingContext();var o={Role:sap.ui.getCore().byId("Secure_Dialog--idRole").getValue(),UserName:sap.ui.getCore().byId("Secure_Dialog--idUser").getValue(),EmailId:sap.ui.getCore().byId("Secure_Dialog--idEmail").getValue(),TechnicalId:sap.ui.getCore().byId("Secure_Dialog--idTech").getValue()};if(s){var r=e.getSource().getBindingContext().sPath;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),r,"PUT",{},o,this).then(function(e){sap.m.MessageToast.show("Server Updated successfully");t.getView().setBusy(false);t._oDialogSecure.close()}).catch(function(e){t.getView().setBusy(false);t.oPopover=t.getErrorMessage(e);t.getView().setBusy(false)})}else{this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/AppUsers","POST",{},o,this).then(function(e){sap.m.MessageToast.show("Server Updated successfully");t.getView().setBusy(false);t._oDialogSecure.close()}).catch(function(e){t.getView().setBusy(false);t.oPopover=t.getErrorMessage(e);t.getView().setBusy(false)})}},_removeCreateMode:function(e){for(var t=0;t<e.length;t++){delete e[t].CreateMode}},_checkForSecureChangesButton:function(){var e=this.getView().getModel("local");var t=e.getData().appUsers;this._removeCreateMode(t)},onPressHandleSecureCancelPopup:function(){this._oDialogSecure.close();this._oDialogSecure.destroy();this._oDialogSecure=null},onPressOpenAddSecureDialog:function(e){if(!this._oDialogSecure){debugger;this._oDialogSecure=sap.ui.xmlfragment("Secure_Dialog","oft.fiori.fragments.SecureDialog",this);this.getView().addDependent(this._oDialogSecure);if(e==false){this._oDialogSecure.bindElement(this.aBindingContext)}else{this._oDialogSecure.unbindElement(this.aBindingContext)}}jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialogSecure);this._oDialogSecure.open()},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},onSave:function(){console.log(this.getView().getModel("local").getProperty("/newBatch"))},onStartChange:function(e){var t=e.getSource().getValue();var s=t.split(".");var o=new Date(s[2],s[1]-1,s[0]);var r=this.formatter.getIncrementDate(o,2.5);this.getView().getModel("local").setProperty("/newBatch/endDate",r);var a=this.formatter.getIncrementDate(o,8);this.getView().getModel("local").setProperty("/newBatch/blogDate",a);console.log(r);console.log(a)},editSecureField:function(e){this.aBindingContext=e.getSource().getBindingContext().sPath;this.onPressOpenAddSecureDialog(false)},_getSecureDetails:function(){var e=this},herculis:function(e){this.getView().getModel("local").setProperty("/newBatch/startDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newBatch/demoDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newBatch/endDate",this.formatter.getFormattedDate(2.5));this.getView().getModel("local").setProperty("/newBatch/blogDate",this.formatter.getFormattedDate(8));this._getSecureDetails()}})});