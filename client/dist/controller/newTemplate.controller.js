sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/Filter"],function(e,t,a,s,i){"use strict";return e.extend("oft.fiori.controller.newTemplate",{formatter:s,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.clearForm();this.oRouter.attachRoutePatternMatched(this.herculis,this);var e=this.getModel("local").getProperty("/CurrentUser");if(e){var t=this.getModel("local").oData.AppUsers[e].UserName;this.getView().byId("idUser").setText(t)}},herculis:function(e){var t=this;if(e.getParameter("name")!=="newTemplate"){return}var a=this.getView().byId("idRecent");a.bindAggregation("items",{path:"/Templates",template:new sap.m.DisplayListItem({label:"{CourseName} - {Type} - {DemoDate}",value:"{ClassTiming} / {NextClass}"})});var s=this.getView().byId("type").getSelectedKey();var i=this.getView().byId("course").getSelectedKey();var l=new sap.ui.model.Filter("CourseName","EQ",i);var o=new sap.ui.model.Filter("Type","EQ",s);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Templates","GET",{filters:[l,o]},{},this).then(function(e){if(e.results.length<1){t.getView().byId("idSave").setEnabled(true);t.getView().byId("idUpdate").setEnabled(false)}else{t.getView().getModel("local").setProperty("/template",e.results[0]);t.getView().byId("idSave").setEnabled(false);t.getView().byId("idUpdate").setEnabled(true)}}).catch(function(e){sap.m.MessageToast.show("template fetch failed")})},clearForm:function(){},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},onTypeSelect:function(e){var t=this;var a=e.getSource().getSelectedKey();var s=this.getView().byId("course").getSelectedKey();var i=new sap.ui.model.Filter("CourseName","EQ",s);var l=new sap.ui.model.Filter("Type","EQ",a);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Templates","GET",{filters:[i,l]},{},this).then(function(e){if(e.results.length<1){t.getView().byId("idSave").setEnabled(true);t.getView().byId("idUpdate").setEnabled(false)}else{t.getView().getModel("local").setProperty("/template",e.results[0]);t.getView().byId("idSave").setEnabled(false);t.getView().byId("idUpdate").setEnabled(true)}}).catch(function(e){sap.m.MessageToast.show("template fetch failed")})},onCourseSelect:function(e){var t=this;var a=e.getSource().getSelectedKey();var s=this.getView().byId("type").getSelectedKey();var i=new sap.ui.model.Filter("CourseName","EQ",a);var l=new sap.ui.model.Filter("Type","EQ",s);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Templates","GET",{filters:[i,l]},{},this).then(function(e){if(e.results.length<1){t.getView().getModel("local").setProperty("/template",{CourseName:null,Type:"R",Template:null,DemoDate:new Date,DemoInvite:null,VideoLink:null,CoursePage:null,ClassTiming:null,NextClass:null,Extra1:null,Extra2:null,ExtraN1:null,ExtraN2:null,ExtraN3:null});t.getView().byId("idSave").setEnabled(true);t.getView().byId("idUpdate").setEnabled(false)}else{t.getView().getModel("local").setProperty("/template",e.results[0]);t.getView().byId("idSave").setEnabled(false);t.getView().byId("idUpdate").setEnabled(true)}}).catch(function(e){sap.m.MessageToast.show("template fetch failed")})},onUpdate:function(e){var t=e;var a=this;var s=this.getView().getModel("local").getProperty("/template");s.DemoDate=this.getView().byId("inqDate").getDateValue();s.CourseName=this.getView().byId("course").getSelectedKey();s.Type=this.getView().byId("type").getSelectedKey();var i={CourseName:s.CourseName,Type:s.Type,Template:s.Template,DemoDate:s.DemoDate,DemoInvite:s.DemoInvite,VideoLink:s.VideoLink,CoursePage:s.CoursePage,ClassTiming:s.ClassTiming,NextClass:s.NextClass,Extra1:s.Extra1};var l=new sap.ui.model.Filter("CourseName","EQ",i.CourseName);var o=new sap.ui.model.Filter("Type","EQ",i.Type);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Templates","GET",{filters:[l,o]},{},this).then(function(e,t){if(e.results.length>0){a.ODataHelper.callOData(a.getOwnerComponent().getModel(),"/Templates('"+e.results[0].id+"')","PUT",{},i,a).then(function(e){a.getView().setBusy(false);sap.m.MessageToast.show("template updated successfully");a.destroyMessagePopover();if(a.getView().byId("idRecent").getBinding("items")){a.getView().byId("idRecent").getBinding("items").refresh()}}).catch(function(e){a.getView().setBusy(false);sap.m.MessageToast.show("template update failed "+e.responseText)})}})},onSave:function(e){var t=e;var a=this;var s=this.getView().getModel("local").getProperty("/template");var i=s?s:{};i.DemoDate=this.getView().byId("inqDate").getDateValue();i.CourseName=this.getView().byId("course").getSelectedKey();i.Type=this.getView().byId("type").getSelectedKey();a.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Templates","POST",{},i,this).then(function(e){a.getView().setBusy(false);sap.m.MessageToast.show("template Saved successfully");a.destroyMessagePopover();if(a.getView().byId("idRecent").getBinding("items")){a.getView().byId("idRecent").getBinding("items").refresh()}}).catch(function(e){a.getView().setBusy(false);sap.m.MessageToast.show("template Saving failed "+e.responseText)})}})});