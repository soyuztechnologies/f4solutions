sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/Filter"],function(e,t,s,a,i){"use strict";return e.extend("oft.fiori.controller.server",{oSorter:null,formatter:a,simpleForm:null,endDate:null,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.herculis,this);var e=this;this.getView().byId("serverSubs").bindElement("local>/newServer");this.getView().byId("serverUId").bindProperty("value","local>User");this.getView().byId("payDate").bindProperty("value","local>PaymentDate");this.getView().byId("customerId").bindProperty("value","local>StudentId");this.getView().byId("startDate").bindProperty("value","local>StartDate");this.getView().byId("endDate").bindProperty("value","local>EndDate");this.getView().byId("userEndDate").bindProperty("value","local>UserEndDate");this.getView().byId("rdpPass").bindProperty("value","local>PassRDP");this.getView().byId("passGui").bindProperty("value","local>PassSAP");this.getView().byId("amount").bindProperty("value","local>Amount");this.getView().byId("usage").bindProperty("value","local>Usage");this.getView().byId("freeAccess").bindProperty("selected","local>FreeAccess");this.getView().byId("Remarks").bindProperty("value","local>Remarks");var t=this.getModel("local").getProperty("/CurrentUser");if(t){var s=this.getModel("local").oData.AppUsers[t].UserName}s="Hey "+s;this.getView().byId("idUser").setText(s);e.getView().setBusy(true);var a=this.getOwnerComponent().getModel();if(a){this.getOwnerComponent().getModel().setUseBatch(false)}var a=this.getOwnerComponent().getModel();if(a){this.getOwnerComponent().getModel().setUseBatch(false)}e.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",null,null,this).then(function(t){e.getView().setBusy(false)}).catch(function(t){var s=e.getErrorMessage(t)});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Servers","GET",null,null,this).then(function(t){e.getView().setBusy(false)}).catch(function(t){var s=e.getErrorMessage(t)})},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},onUpdateFinished:function(e){var t=this.getView().byId("serverTable").getItems();if(t[this.selIndex-1]){var s=t[this.selIndex-1].getCells()[2].getText();var a="Students('"+s+"')";var i=this.getView().getModel().oData[a];t[this.selIndex-1].getCells()[2].setText(i.GmailId)}},onSave:function(){if(this.getView().byId("accountNo").getSelectedKey()===""){sap.m.MessageBox.error("Account no is mandatory");return}var e=this.getView().getModel("local").getProperty("/newServer");var t=new Date;var s=this.getView().byId("payDate").getDateValue();var a=this;this.getView().setBusy(true);var i={User:this.getView().byId("serverUId").getValue().toLocaleUpperCase().toLocaleUpperCase(),StudentId:this.getView().byId("cid").getValue(),PaymentDate:this.getView().byId("payDate").getDateValue(),StartDate:this.getView().byId("startDate").getDateValue(),EndDate:this.getView().byId("endDate").getDateValue(),UserEndDate:this.getView().byId("userEndDate").getDateValue(),Amount:this.getView().byId("amount").getValue(),Usage:this.getView().byId("usage").getValue(),FreeAccess:this.getView().byId("freeAccess").getSelected(),PassRDP:this.getView().byId("rdpPass").getValue(),PassSAP:this.getView().byId("passGui").getValue(),CreatedOn:new Date,CreatedBy:"Menakshi",Remarks:this.getView().byId("Remarks").getValue(),Extended:this.getView().byId("extended").getSelected(),Update:"C"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Servers","POST",{},i,this).then(function(e){sap.m.MessageToast.show("Server Saved successfully");a.destroyMessagePopover();a.getView().byId("serverTable").getBinding("items").refresh(true);$.post("/updateBalanceInAccount",{AccountNo:a.getView().byId("accountNo").getSelectedKey(),Amount:a.getView().byId("amount").getValue()}).done(function(e,t){sap.m.MessageToast.show("Server Entry and Balance Saved succesfully")}).fail(function(e,t,s){sap.m.MessageBox.error(e.responseText)});a.getView().setBusy(false)}).catch(function(e){a.getView().setBusy(false);a.oPopover=a.getErrorMessage(e);a.getView().setBusy(false)})},getAdd8Mon:function(e){var t=new Date(e.getValue().substr(6,4),e.getValue().substr(3,2),e.getValue().substr(0,2));t.setMonth(t.getMonth()+1);var s=t.getMonth()+1;var a=t.getFullYear();if(e<10){e="0"+e}if(s<10){s="0"+s}var i=e+"."+s+"."+a;return i},onStartChange:function(e){var t=e.getSource().getValue();var s=t.split(".");var a=new Date(s[2],s[1]-1,s[0]);var i=this.formatter.getIncrementSDate(a,1);if(e.getSource().sId=="idSimpleForm--startDate"){sap.ui.getCore().byId("idSimpleForm--endDate").setValue(i);sap.ui.getCore().byId("idSimpleForm--userEndDate").setValue(i)}else if(e.getSource().sId=="idSimpleFormRe--startDate"){sap.ui.getCore().byId("idSimpleFormRe--endDate").setValue(i);sap.ui.getCore().byId("idSimpleFormRe--userEndDate").setValue(i)}else{this.getView().byId("endDate").setValue(i);this.getView().byId("userEndDate").setValue(i)}},herculis:function(e){if(e.getParameter("name")!=="server"){return}var t=this;this.getView().getModel("local").setProperty("/newServer/StartDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newServer/PaymentDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newServer/EndDate",this.formatter.getFormattedSDate(1));this.getView().getModel("local").setProperty("/newServer/UserEndDate",this.formatter.getFormattedSDate(1));var s=new Date;var a=new sap.ui.model.Filter("EndDate","GT",s);var i=new sap.ui.model.Filter({filters:[a]});var r=[i];this.getView().byId("serverTable").getBinding("items").filter(r);this.getView().byId("accountNo").setSelectedKey("50180025252811")},searchPopup:null,sId:"",onSelect:function(e){this.getCustomerPopup();var t=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(t);this.searchPopup.bindAggregation("items",{path:"/Students",template:new sap.m.DisplayListItem({label:"{Name}",value:"{GmailId}"})})},onStudenIdChange:function(e){var t=e.getSource().oPropagatedProperties.oBindingContexts.undefined.sPath;t=t.split("/")[1];var s=this.getView().getModel().oData[t].StudentId;s="Students('"+s+"')";var a=this.getView().getModel().oData[s];if(a){var i=a.GmailId;e.getSource().setText(i)}},onCustomerIdChange:function(e){var t=e.getSource().oParent.oParent.oParent.oParent.mObjectBindingInfos.undefined.path;t=t.split("/")[1];var s=this.getView().getModel().oData[t].StudentId;s="Students('"+s+"')";var a=this.getView().getModel().oData[s];if(a){if(e.getSource().sId=="idSimpleForm--customerId"){sap.ui.getCore().byId("idSimpleForm--customerId").setValue(a.GmailId);sap.ui.getCore().byId("idSimpleForm--name").setText(a.Name)}else{sap.ui.getCore().byId("idSimpleFormRe--customerId").setValue(a.GmailId);sap.ui.getCore().byId("idSimpleFormRe--name").setText(a.Name)}}},onReassign:function(e){this.oDialogPopup.close();this.getReasgnPopup();var t=this.getView().getModel("i18n").getProperty("serverUpdate");this.ReasgnPopup.setTitle(t);if(!this.oSimpleFormRe){this.oSimpleFormRe=sap.ui.xmlfragment("idSimpleFormRe","oft.fiori.fragments.ServerSimpleForm",this);this.getView().addDependent(this.oSimpleFormRe);this.ReasgnPopup.addButton(new sap.m.Button({text:"Update",type:"Accept",press:[this.onReUpdate,this]}));this.ReasgnPopup.addButton(new sap.m.Button({text:"Close",type:"Reject",press:[this.onReClose,this]}))}var s=this.getView();var a=e.getSource().getParent().getContent()[0].getBindingContext().sPath;this.oSimpleFormRe.bindElement(a);sap.ui.getCore().byId("idSimpleFormRe--payDate").bindProperty("value",{path:"PaymentDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleFormRe--serverUId").bindProperty("value","User");sap.ui.getCore().byId("idSimpleFormRe--startDate").bindProperty("value",{path:"StartDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleFormRe--endDate").bindProperty("value",{path:"EndDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleFormRe--userEndDate").bindProperty("value",{path:"UserEndDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleFormRe--rdpPass").bindProperty("value","PassRDP");sap.ui.getCore().byId("idSimpleFormRe--passGui").bindProperty("value","PassSAP");sap.ui.getCore().byId("idSimpleFormRe--amount").bindProperty("value","Amount");sap.ui.getCore().byId("idSimpleFormRe--usage").bindProperty("value","Usage");sap.ui.getCore().byId("idSimpleFormRe--freeAccess").bindProperty("selected","FreeAccess");sap.ui.getCore().byId("idSimpleFormRe--extended").bindProperty("selected","Extended");sap.ui.getCore().byId("idSimpleFormRe--Remarks").bindProperty("value","Remarks");sap.ui.getCore().byId("idSimpleFormRe--cid").bindProperty("value","StudentId");sap.ui.getCore().byId("idSimpleFormRe--customerId").attachModelContextChange(this.onCustomerIdChange,this);this.ReasgnPopup.addContent(this.oSimpleFormRe)},onItemPress:function(e){this.getDialogPopup();var t=this.getView().getModel("i18n").getProperty("serverUpdate");this.oDialogPopup.setTitle(t);if(!this.oSimpleForm){this.oSimpleForm=sap.ui.xmlfragment("idSimpleForm","oft.fiori.fragments.ServerSimpleForm",this);this.getView().addDependent(this.oSimpleForm);this.oDialogPopup.addButton(new sap.m.Button({text:"Re-Assign",type:"Accept",press:[this.onReassign,this]}));this.oDialogPopup.addButton(new sap.m.Button({text:"Update",type:"Accept",press:[this.onUpdate,this]}));this.oDialogPopup.addButton(new sap.m.Button({text:"Close",type:"Reject",press:[this.onClose,this]}))}var s=this.getView();this.sPath=e.getSource().getBindingContextPath();this.selIndex=e.getSource().getParent().getItemNavigation().iFocusedIndex;this.oSimpleForm.bindElement(this.sPath);sap.ui.getCore().byId("idSimpleForm--payDate").bindProperty("value",{path:"PaymentDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleForm--serverUId").bindProperty("value","User");sap.ui.getCore().byId("idSimpleForm--startDate").bindProperty("value",{path:"StartDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleForm--endDate").bindProperty("value",{path:"EndDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleForm--userEndDate").bindProperty("value",{path:"UserEndDate",type:"sap.ui.model.type.Date",formatOptions:{pattern:"dd.MM.YYYY"}});sap.ui.getCore().byId("idSimpleForm--rdpPass").bindProperty("value","PassRDP");sap.ui.getCore().byId("idSimpleForm--passGui").bindProperty("value","PassSAP");sap.ui.getCore().byId("idSimpleForm--amount").bindProperty("value","Amount");sap.ui.getCore().byId("idSimpleForm--usage").bindProperty("value","Usage");sap.ui.getCore().byId("idSimpleForm--freeAccess").bindProperty("selected","FreeAccess");sap.ui.getCore().byId("idSimpleForm--extended").bindProperty("selected","Extended");sap.ui.getCore().byId("idSimpleForm--Remarks").bindProperty("value","Remarks");sap.ui.getCore().byId("idSimpleForm--cid").bindProperty("value","StudentId");sap.ui.getCore().byId("idSimpleForm--payDate").setProperty("editable",false);sap.ui.getCore().byId("idSimpleForm--serverUId").setProperty("editable",false);sap.ui.getCore().byId("idSimpleForm--customerId").setProperty("editable",false);sap.ui.getCore().byId("idSimpleForm--customerId").attachModelContextChange(this.onCustomerIdChange,this);this.oDialogPopup.addContent(this.oSimpleForm)},onReUpdate:function(e){var t=e.getSource().getParent().mAggregations.content[0].getBindingContext().sPath;var s=this.getView().getModel().oData[t.split("/")[1]];var a=this;this.getView().setBusy(true);var i={User:sap.ui.getCore().byId("idSimpleFormRe--serverUId").getValue().toLocaleUpperCase(),StudentId:sap.ui.getCore().byId("idSimpleFormRe--cid").getValue(),PaymentDate:sap.ui.getCore().byId("idSimpleFormRe--payDate").getDateValue(),StartDate:sap.ui.getCore().byId("idSimpleFormRe--startDate").getDateValue(),EndDate:sap.ui.getCore().byId("idSimpleFormRe--endDate").getDateValue(),UserEndDate:sap.ui.getCore().byId("idSimpleFormRe--userEndDate").getDateValue(),Amount:sap.ui.getCore().byId("idSimpleFormRe--amount").getValue(),Usage:sap.ui.getCore().byId("idSimpleFormRe--usage").getValue(),FreeAccess:""+sap.ui.getCore().byId("idSimpleFormRe--freeAccess").getSelected()+"",Extended:""+sap.ui.getCore().byId("idSimpleFormRe--extended").getSelected()+"",PassRDP:sap.ui.getCore().byId("idSimpleFormRe--rdpPass").getValue(),PassSAP:sap.ui.getCore().byId("idSimpleFormRe--passGui").getValue(),ReassignStd:sap.ui.getCore().byId("idSimpleFormRe--Rid").getValue(),id:t.split("(")[1].split("'")[1],Remarks:sap.ui.getCore().byId("idSimpleFormRe--Remarks").getValue(),Update:"R"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),t,"PUT",{},i,this).then(function(e){sap.m.MessageToast.show("Server Updated successfully");a.getView().byId("serverTable").getBinding("items").refresh(true);a.onReClose();a.getView().setBusy(false)}).catch(function(e){a.getView().setBusy(false);a.oPopover=a.getErrorMessage(e);a.getView().setBusy(false)})},onUpdate:function(e){var t=e.getSource().getParent().mAggregations.content[0].getBindingContext().sPath;var s=this.getView().getModel().oData[t.split("/")[1]];var a=this;this.getView().setBusy(true);var i={User:sap.ui.getCore().byId("idSimpleForm--serverUId").getValue().toLocaleUpperCase(),StudentId:sap.ui.getCore().byId("idSimpleForm--cid").getValue(),PaymentDate:sap.ui.getCore().byId("idSimpleForm--payDate").getDateValue(),StartDate:sap.ui.getCore().byId("idSimpleForm--startDate").getDateValue(),EndDate:sap.ui.getCore().byId("idSimpleForm--endDate").getDateValue(),UserEndDate:sap.ui.getCore().byId("idSimpleForm--userEndDate").getDateValue(),Amount:sap.ui.getCore().byId("idSimpleForm--amount").getValue(),Usage:sap.ui.getCore().byId("idSimpleForm--usage").getValue(),FreeAccess:""+sap.ui.getCore().byId("idSimpleForm--freeAccess").getSelected()+"",Extended:""+sap.ui.getCore().byId("idSimpleForm--extended").getSelected()+"",PassRDP:sap.ui.getCore().byId("idSimpleForm--rdpPass").getValue(),PassSAP:sap.ui.getCore().byId("idSimpleForm--passGui").getValue(),ChangedOn:new Date,ChangedBy:"Menakshi",id:t.split("(")[1].split("'")[1],Remarks:sap.ui.getCore().byId("idSimpleForm--Remarks").getValue(),Update:"U"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),t,"PUT",{},i,this).then(function(e){sap.m.MessageToast.show("Server Updated successfully");a.getView().setBusy(false);a.onClose()}).catch(function(e){a.getView().setBusy(false);a.oPopover=a.getErrorMessage(e);a.getView().setBusy(false)})},onClose:function(){this.oDialogPopup.close()},onReClose:function(){this.ReasgnPopup.close()},onSearch:function(e){var t=this.getQuery(e);if(t){var s=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("GmailId",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Students",template:new sap.m.DisplayListItem({label:"{Name}",value:"{GmailId}"})});this.searchPopup.getBinding("items").filter([])}},onConfirm:function(e){var t=this.getSelectedKey(e);if(e.getSource().getParent().oController.ReasgnPopup){sap.ui.getCore().byId("idSimpleFormRe--customerId").setValue(t[0]);sap.ui.getCore().byId("idSimpleFormRe--name").setText(t[1]);sap.ui.getCore().byId("idSimpleFormRe--cid").setValue(t[2]);this.getView().byId("customerId").setValue(t[0]);this.getView().byId("name").setText(t[1]);this.getView().byId("cid").setValue(t[2])}else{this.getView().byId("customerId").setValue(t[0]);this.getView().byId("name").setText(t[1]);this.getView().byId("cid").setValue(t[2])}},onWaiver:function(e){var t=e.getParameter("selected");if(e.getSource().sId=="__component0---idserver--freeAccess"){if(t===true){this.getView().byId("amount").setValue(0)}else{this.getView().byId("amount").setValue(2500)}}else if(e.getSource().sId=="idSimpleFormRe--freeAccess"){if(t===true){sap.ui.getCore().byId("idSimpleFormRe--amount").setValue(0)}else{sap.ui.getCore().byId("idSimpleFormRe--amount").setValue(2500)}}else{if(t===true){sap.ui.getCore().byId("idSimpleForm--amount").setValue(0)}else{sap.ui.getCore().byId("idSimpleForm--amount").setValue(2500)}}},onTabSearch:function(e){var t=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;var s=this.getQuery(e);if(s){var a;var i;if(t.test(s)){var r=this;var o={};var d=new sap.ui.model.Filter("GmailId","EQ",s);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[d]},o,this).then(function(e){var t=[new sap.ui.model.Filter("StudentId","EQ","'"+e.results[0].id+"'")];r.getView().byId("serverTable").getBinding("items").filter(t)}).catch(function(e){})}else{a=new sap.ui.model.Filter("User",sap.ui.model.FilterOperator.EQ,s);var n=new sap.ui.model.Filter({filters:[a],and:false});var l=[n];this.getView().byId("serverTable").getBinding("items").filter(l)}}else{this.getView().byId("serverTable").getBinding("items").filter([])}},onClearScreen:function(){this.getView().getModel("local").setProperty("/newServer/User",null);this.getView().getModel("local").setProperty("/newServer/PassSAP",null);this.getView().getModel("local").setProperty("/newServer/PassRDP",null)},onDelete:function(e){var s=this;t.confirm("Do you want to delete the selected records?",function(e){if(e=="OK"){var t=s.getView().byId("serverTable").getSelectedContexts();for(var a=0;a<t["length"];a++){s.ODataHelper.callOData(s.getOwnerComponent().getModel(),t[a].sPath,"DELETE",{},{},s).then(function(e){sap.m.MessageToast.show("Deleted succesfully")}).catch(function(e){s.getView().setBusy(false);s.oPopover=s.getErrorMessage(e);s.getView().setBusy(false)})}}},"Confirmation")},onSwitchToggle:function(e){var t=e.getSource().getState();var s=new Date;var a=this.getQuery(e);if(t===true){this.getView().byId("serverTable").getBinding("items").filter(null)}else{var i=new sap.ui.model.Filter("EndDate","GT",s);var r=new sap.ui.model.Filter({filters:[i]});var o=[r];this.getView().byId("serverTable").getBinding("items").filter(o)}},passwords:"",onEmail:function(){var e=this;var t=e.getView().byId("serverTable").getSelectedContexts();for(var s=0;s<t["length"];s++){var a=t[s].getModel().getProperty(t[s].getPath());if(this.passwords===""){this.passwords=prompt("Please enter your password","");if(this.passwords===""){sap.m.MessageBox.error("Blank Password not allowed");return}}a.password=this.passwords;a.isServer2=this.getView().byId("server2").getSelected();$.post("/sendServerEmail",a).done(function(e,t){sap.m.MessageToast.show("Email sent successfully")}).fail(function(t,s,a){e.passwords="";sap.m.MessageBox.error(t.responseText)})}},onDataExport:function(e){var t=this.getView().byId("idSwitch").getState();if(t==true){$.ajax({type:"GET",url:"ServerDownload",success:function(e){sap.m.MessageToast.show("File Downloaded succesfully")},error:function(e,t,s){sap.m.MessageToast.show("error in downloading the excel file")}})}else{$.ajax({type:"GET",url:"ServerDownloadAct",success:function(e){sap.m.MessageToast.show("File Downloaded succesfully")},error:function(e,t,s){sap.m.MessageToast.show("error in downloading the excel file")}})}}})});