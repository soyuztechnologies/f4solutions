sap.ui.define(["oft/fiori/controller/BaseController","sap/ui/core/Core","sap/ui/model/Filter","sap/ui/model/FilterOperator","oft/fiori/models/formatter","sap/ui/core/Fragment","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,n,a,o,i,r,l){"use strict";return e.extend("oft.fiori.controller.GSTInvoices",{formatter:o,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.onBankAccount,this)},formatter:o,onBankAccount:function(e){if(e.getParameter("name")!="GSTInvoices"){return}var t=new Date;var n=t.getMonth()+1;var a=t.getFullYear();var o=new Date(a+" "+n);this.getView().byId("idRegDate").setValue(o.toDateString().slice(4));this.getView().byId("idRegDateTo").setValue(t.toDateString().slice(4));var i=this;$.ajax({type:"GET",url:"getLogo",success:function(e){i.logo=e},error:function(e,t,n){sap.m.MessageToast.show("error in fetching logo")}});$.ajax({type:"GET",url:"getSignature",success:function(e){i.signature=e},error:function(e,t,n){sap.m.MessageToast.show("error in fetching signature")}})},onLiveSearch:function(e){var t=e.getParameter("value");var o=[new n("value",a.Contains,t),new n("key",a.Contains,t)];var i=e.getParameter("itemsBinding");i.filter(new n(o,false))},onConfirm:function(e){if(this.sId.indexOf("accountDetails")!==-1){var n=e.getParameter("selectedItem").getValue();this.getView().getModel("local").setProperty("/GSTInvoices/AccountNo",n);var a=this.getView().byId("idRegDate").getValue();var o=this.getView().byId("idRegDateTo").getValue();this.accountNo=n;this.super(n,a,o)}else if(this.sId.indexOf("idAccountNo")!==-1){var n=e.getParameter("selectedItem").getValue();t.byId("idAccountNo").setValue(n)}},onStartDate:function(){var e=this.getView().getModel("local").getProperty("/GSTInvoices/AccountNo");var t=this.getView().byId("idRegDate").getValue();var n=this.getView().byId("idRegDateTo").getValue();this.super(e,t,n)},onEndDate:function(e){this.onStartDate()},payMode:"ALL",onPayModeSelect:function(e){this.payMode=e.getSource().getSelectedItem().getKey();this.onStartDate()},onReference:function(e){var t=e.getSource().getParent().getBindingContextPath(),n=e.getSource().getParent().getModel("viewModel").getProperty(t+"/Reference");open("https://www.paypal.com/myaccount/transaction/details/"+n,"paypal","width=1200,height=600")},onEditInfo:function(e){var n=this;var a=e.getSource().getParent().getModel("viewModel").getProperty(e.getSource().getParent().getBindingContextPath());var o=a.id;var i=n.getView().getModel("local").getProperty("/CurrentUser");var l=a.FullAmount;var s=new sap.m.Dialog({type:sap.m.DialogType.Message,title:"Modify : "+a.Email,contentWidth:"450px",content:[new sap.m.Label({text:"payment Mode: "}),new sap.m.Select("idPaymentMode",{items:[new sap.ui.core.Item({key:"IMPS",text:"Internet Banking"}),new sap.ui.core.Item({key:"PAYTM",text:"PayTM"}),new sap.ui.core.Item({key:"PAYPAL",text:"Paypal/Xoom"}),new sap.ui.core.Item({key:"PAYU",text:"PayUMoney"}),new sap.ui.core.Item({key:"USA",text:"Wire Transfer"}),new sap.ui.core.Item({key:"FOREIGN",text:"Foregin Transfer"})],width:"100%",selectedKey:a.PaymentMode}),new sap.m.Label({text:"Amount: "}),new sap.m.Input("idAmount",{type:"Number",value:l}),new sap.m.Label({text:"Paypal Amount: "}),new sap.m.Input("idUSDAmount",{type:"Number",value:a.USDAmount,enabled:a.IsWallet}),new sap.m.Label({text:"Currency Code: "}),new sap.m.Input("idCurrencyCode",{value:a.CurrencyCode,enabled:a.IsWallet}),new sap.m.Label({text:"Charges: "}),new sap.m.Input("idCharges",{type:"Number",value:a.Charges,enabled:a.IsWallet}),new sap.m.Label({text:"Exchange: ",required:a.IsWallet}),new sap.m.Input("idExchange",{type:"Number",value:a.Exchange,enabled:a.IsWallet,liveChange:e=>{var n=t.byId("idUSDAmount").getValue()-t.byId("idCharges").getValue();t.byId("idSettleAmount").setValue((n*e.getParameter("value")).toFixed(2))}}),new sap.m.Label({text:"Settle Amount: "}),new sap.m.Input("idSettleAmount",{type:"Number",value:a.SettleAmount,enabled:false}),new sap.m.Label({text:"Settle Date: "}),new sap.m.DatePicker("idSettleDate",{displayFormat:"dd.MM.yyyy",valueFormat:"MMM dd yyyy",value:a.SettleDate,enabled:a.IsWallet}),new sap.m.Label({text:"Account No: "}),new sap.m.Input("idAccountNo",{value:n.accountNo,showValueHelp:true,valueHelpOnly:true,valueHelpRequest:[n.onSelect,this]}),new sap.m.Label({text:"Reference: "}),new sap.m.Input("idReference",{value:a.Reference}),new sap.m.CheckBox("idConfirm",{text:"Confirm",select:function(e){s.getBeginButton().setEnabled(e.getParameter("selected"))}.bind(this)})],beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,enabled:false,text:"Submit",press:function(){var e=t.byId("idAmount").getValue();var l=t.byId("idUSDAmount").getValue();var d=t.byId("idCurrencyCode").getValue();var u=t.byId("idExchange").getValue();var c=t.byId("idPaymentMode").getSelectedKey();var g=t.byId("idCharges").getValue();var m=t.byId("idSettleDate").getValue();var h=t.byId("idSettleAmount").getValue();var p=t.byId("idAccountNo").getValue();var f=t.byId("idReference").getValue();var y={};if(a.IsWallet){y={id:o,Amount:e,USDAmount:l,CurrencyCode:d,Exchange:u,Charges:g,SettleDate:m,SettleAmount:h,PaymentMode:c,Reference:f,ChangedBy:i}}else{y={id:o,Amount:e,PaymentMode:c,Reference:f,ChangedBy:i}}if(p){y.AccountName=p}if(e<=9e4){$.post("/updateSubcriptionAmount",y).done(function(e,t){r.success("Update "+e);n.destroyEditItems();s.destroy();n.onStartDate()}).fail(function(e,t,a){n.destroyEditItems();s.destroy();r.error("Error in access")});s.close()}else{r.error("No Subcription is greater than 90,000")}}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){n.destroyEditItems();s.close();s.destroy()}.bind(this)})});s.open()},destroyEditItems:function(){t.byId("idAmount").destroy();t.byId("idUSDAmount").destroy();t.byId("idCurrencyCode").destroy();t.byId("idExchange").destroy();t.byId("idPaymentMode").destroy();t.byId("idCharges").destroy();t.byId("idSettleDate").destroy();t.byId("idSettleAmount").destroy();t.byId("idReference").destroy();t.byId("idConfirm").destroy()},getCountryNameFromCode:function(e){var t=this.getView().getModel("local").getProperty("/countries");var n="";t.forEach(t=>{if(t.code===e){n=t.name;return}});return n?n:e},onFullScreen:function(e){var t=e.getSource().getParent().getParent().getParent().getParent().getParent().getParent().getParent().getMode();if(t==="ShowHideMode"){e.getSource().getParent().getParent().getParent().getParent().getParent().getParent().getParent().setMode("HideMode");e.getSource().setIcon("sap-icon://exit-full-screen");e.getSource().setText("Hide Fullscreen")}else{e.getSource().getParent().getParent().getParent().getParent().getParent().getParent().getParent().setMode("ShowHideMode");e.getSource().setIcon("sap-icon://full-screen");e.getSource().setText("Show Fullscreen")}},onAddressMail:function(e){var t=e.getSource().getParent().getParent().getSelectedContextPaths();if(!this.emailApproveDialog){this.emailApproveDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:"Confirm",content:new sap.m.Text({text:"Please Confirm"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Submit",press:function(){t.forEach((e,t)=>{var n=this.getView().getModel("viewModel").getProperty(e);$.post("/sendEmailForAddress",{UserName:n.Name,EmailId:n.Email,Subject:"[URGENT Action Required]"}).done(function(e,t){l.show("Email Sent")}).fail(function(e,t,n){r.error("Error in sending Mail")})});this.emailApproveDialog.close()}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this.emailApproveDialog.close()}.bind(this)})})}this.emailApproveDialog.open()},onGenerateInvoiceNo:function(e){var t=this;var n=e.getSource().getParent().getParent().getSelectedContextPaths();var a=this.getView().getModel("local").getProperty("/CurrentUser");const o=(e,n=0)=>{var i=this.getView().getModel("viewModel").getProperty(e[n]);if(i.IsWallet&&i.SettleAmount===0){l.show("Incomplete Information, can't generate Invoice No");if(++n<e.length){o(e,n)}if(e.length===n){t.onStartDate();t.getView().setBusy(false);r.success("Invoice no. generated for all")}}else{if(i.InvoiceNo==="null"||i.InvoiceNo===""){$.post("/getInvoiceNo",{SubcriptionId:i.id,PaymentDate:i.PaymentDate,UserId:a}).done(function(a,i){if(++n<e.length){o(e,n)}if(e.length===n){t.onStartDate();t.getView().setBusy(false);r.success("Invoice no. generated for all")}}).fail(function(e,n,a){r.error("Error in Invoice no.");t.getView().setBusy(false)})}else{if(++n<e.length){o(e,n)}if(e.length===n){t.onStartDate();t.getView().setBusy(false);r.success("Invoice no. generated for all")}}}};if(n.length<1){r.alert("Please select atleast one/all")}else{r.confirm("Please confirm?",function(e){if(e==="OK"){t.getView().setBusy(true);o(n)}})}},onDownloadAllInvoice:function(e){var t=this;var n=e.getSource().getParent().getParent().getSelectedContextPaths();var a=this.getView().getModel("local").getProperty("/CurrentUser");const o=(e,n=0)=>{var i=this.getView().getModel("viewModel").getProperty(e[n]);var s=(i.Address!="null"?i.Address+", ":"")+(i.City!="null"?i.City+", ":"");var d=new RegExp("haryana","i");var u=d.test(s);var c=i.GSTIN!="null"&&i.GSTIN!="";if(i.IsWallet&&i.SettleAmount===0){l.show("Incomplete Information, can't download");if(++n<e.length){o(e,n)}}else{if(i.InvoiceNo==="null"||i.InvoiceNo===""){$.post("/getInvoiceNo",{SubcriptionId:i.id,PaymentDate:i.PaymentDate,UserId:a}).done(function(a,r){if(!u&&c){t.DownloadInvoiceForOther(i,a)}else{t.DownloadInvoice(i,a)}if(++n<e.length){setTimeout(()=>{o(e,n)},800)}}).fail(function(e,t,n){r.error("Error in Invoice no.")})}else{if(!u&&c){t.DownloadInvoiceForOther(i,i.InvoiceNo)}else{t.DownloadInvoice(i,i.InvoiceNo)}if(++n<e.length){setTimeout(()=>{o(e,n)},1e3)}}}};if(n.length>0){o(n)}setTimeout(()=>{this.onStartDate()},1250*n.length)},onDownloadInvoice:function(e){var t=this;var n=e.getSource().getParent().getModel("viewModel").getProperty(e.getSource().getParent().getBindingContextPath());var a=(n.Address!="null"?n.Address+", ":"")+(n.City!="null"?n.City+", ":"");var o=this.getView().getModel("local").getProperty("/CurrentUser");var i=new RegExp("haryana","i");var s=new RegExp("INV-","i");var d=i.test(a);var u=n.GSTIN!="null"&&n.GSTIN!="";if(n.IsWallet&&n.SettleAmount===0){l.show("Incomplete Information, can't download")}else{if(!s.test(n.InvoiceNo)){$.post("/getInvoiceNo",{SubcriptionId:n.id,PaymentDate:n.PaymentDate,UserId:o}).done(function(e,a){if(!d&&u){t.DownloadInvoiceForOther(n,e)}else{t.DownloadInvoice(n,e)}t.onStartDate()}).fail(function(e,t,n){r.error("Error in Invoice no.")})}else{if(!d&&u){t.DownloadInvoiceForOther(n,n.InvoiceNo)}else{t.DownloadInvoice(n,n.InvoiceNo)}}}},DownloadInvoice:function(e,t){var n=this.getCountryNameFromCode(e.Country);var a=new Date(e.PaymentDate).toDateString().slice(4).split(" ");a=a[0]+" "+a[1]+", "+a[2];var o=[{Course:e.CourseName,Batch:e.BatchNo,HSN:"999293",Qty:1,Rate:e.Amount,CGST:e.IsGST?"9%":"0%",SGST:e.IsGST?"9%":"0%",Amount:e.Amount}];const i={shipping:{name:e.Name,email:e.Email,mob:e.ContactNo?"+"+e.ContactNo:"",GSTIN:e.GSTIN!="null"?e.GSTIN:"",address:(e.Address!="null"?e.Address+", ":"")+(e.City!="null"?e.City+", ":"")+n},items:o,CGST:e.CGST,SGST:e.SGST,fullAmount:e.IsWallet?(parseFloat(e.USDAmount)*parseFloat(e.Exchange)).toFixed(2):e.FullAmount,usdAmount:e.USDAmount,order_number:t,paymentMode:e.PaymentMode,IsWallet:e.IsWallet,header:{company_name:"Soyuz Technologies LLP",company_logo:"data:image/png;base64,"+this.logo,signature:"data:image/png;base64,"+this.signature,company_address:"EPS-FF-073A, Emerald Plaza,\\Golf Course Extension Road,\\Sector 65, Gurgaon,\\Haryana-122102",GSTIN:e.IsGST?"06AEFFS9740G1ZS":""},footer:{text:"This is a computer generated invoice"},currency_symbol:" INR",date:{billing_date:a}};let r=(e,t)=>{if(this.logo){e.image(t.header.company_logo,50,45,{width:50}).fontSize(20).text(t.header.company_name,110,57).fontSize(10).text("GSTIN: "+t.header.GSTIN,112,87).moveDown()}else{e.fontSize(20).text(t.header.company_name,50,45).fontSize(10).text("GSTIN: "+t.header.GSTIN,50,75).moveDown()}if(t.header.company_address.length!==0){y(e,t.header.company_address)}};let l=(e,t)=>{e.fillColor("#444444").fontSize(20).text("Invoice",50,160);g(e,185);const n=200;e.fontSize(10).text("Name:",50,n).font("Helvetica-Bold").text(t.shipping.name,150,n).font("Helvetica").text("E-mail:",50,n+15).text(t.shipping.email,150,n+15).text("Mob.:",50,n+30).text(t.shipping.mob,150,n+30).fontSize(9).text("GSTIN:",50,n+45).text(t.shipping.GSTIN,150,n+45).fontSize(10).text("Address:",50,n+60).text(t.shipping.address,150,n+60).text("Invoice Number:",350,n).font("Helvetica-Bold").text(t.order_number,450,n).font("Helvetica").text("Invoice Date:",350,n+15).text(t.date.billing_date,450,n+15).text("Payment Mode:",350,n+30).font("Helvetica-Bold").text(t.paymentMode,450,n+30).moveDown();g(e,280)};let s=(t,n)=>{let a;const o=330;const i=n.currency_symbol;t.font("Helvetica-Bold");c(t,o,"Course","Batch","HSN/SAC","Rate","CGST","SGST","Amount");g(t,o+20);t.font("Helvetica");var r=0;var l=0;for(a=0;a<n.items.length;a++){const e=n.items[a];const i=o+(a+1)*30;c(t,i,e.Course,e.Batch,e.HSN,e.Rate,e.CGST,e.SGST,e.Amount);r+=parseFloat(e.Amount);g(t,i+20)}const s=o+(a+1)*30;t.font("Helvetica-Bold");u(t,s,"Sub Total:",m(r.toFixed(2)));const d=s+20;t.font("Helvetica-Bold");u(t,d,"CGST:",m(n.CGST));const h=d+20;t.font("Helvetica-Bold");u(t,h,"SGST:",m(n.SGST));const p=h+20;t.font("Helvetica-Bold");u(t,p,"Total (INR):",m(n.fullAmount));let f=h+20;g(t,f+20);t.font("Helvetica-Bold").text("Amount in Words:",50,f+30).text(this.formatter.convertNumberToWords(n.fullAmount)+" only",150,f+30);g(t,f+50);if(n.IsWallet){t.font("Helvetica-Bold").text("Paypal Exchange",50,f+80);f+=10;t.font("Helvetica").text("---------------------------------------------------",50,f+78).text("|\n|\n|\n|\n|\n|\n|\n|\n|\n|\n|",50,f+82).text("|\n|\n|\n|\n|\n|\n|\n|\n|\n|\n|",115,f+82,{width:105,align:"right"}).text("---------------------------------------------------",50,f+201).text("Amount:",60,f+100).text(m(n.usdAmount)+" "+e.CurrencyCode,115,f+100,{width:90,align:"right"}).text("Fee:",60,f+120).text("-"+m(e.Charges)+" "+e.CurrencyCode,115,f+120,{width:90,align:"right"}).text("------------------",120,f+132,{width:90,align:"right"}).text("Sub Total:",60,f+145).text(m(e.USDAmount-e.Charges)+" "+e.CurrencyCode,115,f+145,{width:90,align:"right"}).text("Ex. Rate:",60,f+165).text(m(e.Exchange)+" INR",115,f+165,{width:90,align:"right"}).text("Amount(INR):",60,f+185).text(m(e.SettleAmount)+" INR",115,f+185,{width:90,align:"right"})}const y=f+200;if(this.signature){t.text(n.header.company_name,430,y).image(n.header.signature,440,y+20,{height:50,width:110}).text("Designated Partner",440,y+80).moveDown()}else{t.text(n.header.company_name,430,y).text("Designated Partner",440,y+80).moveDown()}};let d=(e,t)=>{if(t.footer.text.length!==0){g(e,760);e.fontSize(8).text(t.footer.text,50,770,{align:"right",width:500})}};let u=(e,t,n,a)=>{e.fontSize(10).text(n,380,t,{width:90,align:"right"}).text(a,0,t,{align:"right"})};let c=(e,t,n,a,o,i,r,l,s)=>{e.fontSize(10).text(n,50,t).text(a,160,t).text(o,222,t,{width:90,align:"right"}).text(i,300,t,{width:90,align:"right"}).text(r,350,t,{width:90,align:"right"}).text(l,400,t,{width:90,align:"right"}).text(s,0,t,{align:"right"})};let g=(e,t)=>{e.strokeColor("#aaaaaa").lineWidth(1).moveTo(50,t).lineTo(550,t).stroke()};let m=(e,t="")=>{if(e){var n=e.toString().split(".");var a=n.length>1?"."+n[1]:"";n=n[0];var o=n.substring(n.length-3);var i=n.substring(0,n.length-3);if(i!="")o=","+o;var r=i.replace(/\B(?=(\d{2})+(?!\d))/g,",")+o;return r+a+t}else{return e+t}};let h=e=>{if(e.length!==0){var t=e.replace(/[^0-9]/g,"")}else{var t=0}return t};let p=e=>{let t=h(e);if(Number.isNaN(t)===false&&t<=100&&t>0){var n=e}else{var n="---"}return n};let f=(e,t)=>{let n=h(t);if(Number.isNaN(n)===false&&n<=100){let t="."+n;var a=e*(1+t)}else{var a=e*(1+taxValue)}return a};let y=(e,t)=>{let n=t;let a=n.split("\\");let o=50;a.forEach(function(t,n){e.fontSize(10).text(a[n],300,o,{align:"right"});o=+o+15})};let v=n=>{var a=new PDFDocument({size:"A4",margin:40});var o=a.pipe(blobStream());r(a,n);l(a,n);s(a,n);d(a,n);a.end();o.on("finish",function(){const n=o.toBlob("application/pdf");const a=o.toBlobURL("application/pdf");const i=document.createElement("a");i.href=a;i.download=t+"_"+e.Country+"_"+e.Name;i.click()})};v(i)},DownloadInvoiceForOther:function(e,t){var n=this.getCountryNameFromCode(e.Country);var a=new Date(e.PaymentDate).toDateString().slice(4).split(" ");a=a[0]+" "+a[1]+", "+a[2];var o=[{Course:e.CourseName,Batch:e.BatchNo,HSN:"999293",Qty:1,Rate:e.Amount,IGST:e.IsGST?"18%":"0%",Amount:e.Amount}];const i={shipping:{name:e.Name,email:e.Email,mob:e.ContactNo?"+"+e.ContactNo:"",GSTIN:e.GSTIN!="null"?e.GSTIN:"",address:(e.Address!="null"?e.Address+", ":"")+(e.City!="null"?e.City+", ":"")+n},items:o,IGST:parseFloat(e.CGST)+parseFloat(e.SGST),fullAmount:e.IsWallet?(parseFloat(e.USDAmount)*parseFloat(e.Exchange)).toFixed(2):e.FullAmount,usdAmount:e.USDAmount,order_number:t,paymentMode:e.PaymentMode,IsWallet:e.IsWallet,header:{company_name:"Soyuz Technologies LLP",company_logo:"data:image/png;base64,"+this.logo,signature:"data:image/png;base64,"+this.signature,company_address:"EPS-FF-073A, Emerald Plaza,\\Golf Course Extension Road,\\Sector 65, Gurgaon,\\Haryana-122102",GSTIN:e.IsGST?"06AEFFS9740G1ZS":""},footer:{text:"This is a computer generated invoice"},currency_symbol:" INR",date:{billing_date:a}};let r=(e,t)=>{if(this.logo){e.image(t.header.company_logo,50,45,{width:50}).fontSize(20).text(t.header.company_name,110,57).fontSize(10).text("GSTIN: "+t.header.GSTIN,112,87).moveDown()}else{e.fontSize(20).text(t.header.company_name,50,45).fontSize(10).text("GSTIN: "+t.header.GSTIN,50,75).moveDown()}if(t.header.company_address.length!==0){y(e,t.header.company_address)}};let l=(e,t)=>{e.fillColor("#444444").fontSize(20).text("Invoice",50,160);g(e,185);const n=200;e.fontSize(10).text("Name:",50,n).font("Helvetica-Bold").text(t.shipping.name,150,n).font("Helvetica").text("E-mail:",50,n+15).text(t.shipping.email,150,n+15).text("Mob.:",50,n+30).text(t.shipping.mob,150,n+30).fontSize(9).text("GSTIN:",50,n+45).text(t.shipping.GSTIN,150,n+45).fontSize(10).text("Address:",50,n+60).text(t.shipping.address,150,n+60).text("Invoice Number:",350,n).font("Helvetica-Bold").text(t.order_number,450,n).font("Helvetica").text("Invoice Date:",350,n+15).text(t.date.billing_date,450,n+15).text("Payment Mode:",350,n+30).font("Helvetica-Bold").text(t.paymentMode,450,n+30).moveDown();g(e,280)};let s=(t,n)=>{let a;const o=330;const i=n.currency_symbol;t.font("Helvetica-Bold");c(t,o,"Course","Batch","HSN/SAC","Rate","IGST","Amount");g(t,o+20);t.font("Helvetica");var r=0;var l=0;for(a=0;a<n.items.length;a++){const e=n.items[a];const i=o+(a+1)*30;c(t,i,e.Course,e.Batch,e.HSN,e.Rate,e.IGST,e.Amount);r+=parseFloat(e.Amount);g(t,i+20)}const s=o+(a+1)*30;t.font("Helvetica-Bold");u(t,s,"Sub Total:",m(r.toFixed(2)));const d=s+20;t.font("Helvetica-Bold");u(t,d,"IGST:",m(n.IGST));const h=d+20;t.font("Helvetica-Bold");u(t,h,"Total (INR):",m(n.fullAmount));let p=d+20;g(t,p+20);t.font("Helvetica-Bold").text("Amount in Words:",50,p+30).text(this.formatter.convertNumberToWords(n.fullAmount)+" only",150,p+30);g(t,p+50);if(n.IsWallet){t.font("Helvetica-Bold").text("Paypal Exchange",50,p+80);p+=10;t.font("Helvetica").text("---------------------------------------------------",50,p+78).text("|\n|\n|\n|\n|\n|\n|\n|\n|\n|\n|",50,p+82).text("|\n|\n|\n|\n|\n|\n|\n|\n|\n|\n|",115,p+82,{width:105,align:"right"}).text("---------------------------------------------------",50,p+201).text("Amount:",60,p+100).text(m(n.usdAmount)+" "+e.CurrencyCode,115,p+100,{width:90,align:"right"}).text("Fee:",60,p+120).text("-"+m(e.Charges)+" "+e.CurrencyCode,115,p+120,{width:90,align:"right"}).text("------------------",120,p+132,{width:90,align:"right"}).text("Sub Total:",60,p+145).text(m(e.USDAmount-e.Charges)+" "+e.CurrencyCode,115,p+145,{width:90,align:"right"}).text("Ex. Rate:",60,p+165).text(m(e.Exchange)+" INR",115,p+165,{width:90,align:"right"}).text("Amount(INR):",60,p+185).text(m(e.SettleAmount)+" INR",115,p+185,{width:90,align:"right"})}const f=p+200;if(this.signature){t.text(n.header.company_name,430,f).image(n.header.signature,440,f+20,{height:50,width:110}).text("Designated Partner",440,f+80).moveDown()}else{t.text(n.header.company_name,430,f).text("Designated Partner",440,f+80).moveDown()}};let d=(e,t)=>{if(t.footer.text.length!==0){g(e,760);e.fontSize(8).text(t.footer.text,50,770,{align:"right",width:500})}};let u=(e,t,n,a)=>{e.fontSize(10).text(n,380,t,{width:90,align:"right"}).text(a,0,t,{align:"right"})};let c=(e,t,n,a,o,i,r,l)=>{e.fontSize(10).text(n,50,t).text(a,160,t).text(o,222,t,{width:90,align:"right"}).text(i,300,t,{width:90,align:"right"}).text(r,380,t,{width:90,align:"right"}).text(l,0,t,{align:"right"})};let g=(e,t)=>{e.strokeColor("#aaaaaa").lineWidth(1).moveTo(50,t).lineTo(550,t).stroke()};let m=(e,t="")=>{if(e){var n=e.toString().split(".");var a=n.length>1?"."+n[1]:"";n=n[0];var o=n.substring(n.length-3);var i=n.substring(0,n.length-3);if(i!="")o=","+o;var r=i.replace(/\B(?=(\d{2})+(?!\d))/g,",")+o;return r+a+t}else{return e+t}};let h=e=>{if(e.length!==0){var t=e.replace(/[^0-9]/g,"")}else{var t=0}return t};let p=e=>{let t=h(e);if(Number.isNaN(t)===false&&t<=100&&t>0){var n=e}else{var n="---"}return n};let f=(e,t)=>{let n=h(t);if(Number.isNaN(n)===false&&n<=100){let t="."+n;var a=e*(1+t)}else{var a=e*(1+taxValue)}return a};let y=(e,t)=>{let n=t;let a=n.split("\\");let o=50;a.forEach(function(t,n){e.fontSize(10).text(a[n],300,o,{align:"right"});o=+o+15})};let v=n=>{var a=new PDFDocument({size:"A4",margin:40});var o=a.pipe(blobStream());r(a,n);l(a,n);s(a,n);d(a,n);a.end();o.on("finish",function(){const n=o.toBlob("application/pdf");const a=o.toBlobURL("application/pdf");const i=document.createElement("a");i.href=a;i.download=t+"_"+e.Country+"_"+e.Name;i.click()})};v(i)},onWalletCalculator:function(e){if(!this.oConfirmDialog){this.oConfirmDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:"Calculator",content:[new sap.ui.layout.HorizontalLayout({content:[new sap.ui.layout.VerticalLayout({content:[new sap.m.Label({text:"Wallet Amount",required:true}),new sap.m.Input("idWalletAmount",{value:0,liveChange:function(){var e=t.byId("idWalletFee").getValue();var n=t.byId("idIndianAmount").getValue()/(t.byId("idWalletAmount").getValue()-e);n=n.toFixed(4);t.byId("idExchangeRate").setText(n);t.byId("idFeeINR").setText((e*n).toFixed(2))}}),new sap.m.Label({text:"Exch. Rate:",required:true}),new sap.m.Label({text:"Fee(INR): ",required:true}),new sap.m.Label({text:"Total Credit:+"}),new sap.m.Label({text:"Total Fees:+"})]}),new sap.ui.layout.VerticalLayout({content:[new sap.m.Label({text:"Wallet Fee",required:true}),new sap.m.Input("idWalletFee",{value:0,liveChange:function(){var e=t.byId("idWalletFee").getValue();var n=t.byId("idIndianAmount").getValue()/(t.byId("idWalletAmount").getValue()-e);n=n.toFixed(4);t.byId("idExchangeRate").setText(n);t.byId("idFeeINR").setText((e*n).toFixed(2))}}),new sap.m.Text("idExchangeRate",{text:0}),new sap.m.Text("idFeeINR",{text:0}),new sap.m.Label({text:"--"}),new sap.m.Text("idTotalCredit",{text:0}),new sap.m.Text("idTotalFees",{text:0})]}),new sap.ui.layout.VerticalLayout({content:[new sap.m.Label({text:"Bank Amount",required:true}),new sap.m.Input("idIndianAmount",{value:0,liveChange:function(){var e=t.byId("idWalletFee").getValue();var n=t.byId("idIndianAmount").getValue()/(t.byId("idWalletAmount").getValue()-e);n=n.toFixed(4);t.byId("idExchangeRate").setText(n);t.byId("idFeeINR").setText((e*n).toFixed(2))}})]})]})],beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Add",press:function(){var e=parseFloat(t.byId("idTotalCredit").getText());t.byId("idTotalCredit").setText(e+parseFloat(t.byId("idIndianAmount").getValue()));var n=parseFloat(t.byId("idTotalFees").getText());t.byId("idTotalFees").setText((n+parseFloat(t.byId("idFeeINR").getText())).toFixed(2))}.bind(this)}),endButton:new sap.m.Button({text:"Close",press:function(){t.byId("idTotalFees").setText(0);t.byId("idTotalCredit").setText(0);this.oConfirmDialog.close()}.bind(this)})})}this.oConfirmDialog.open()},onSelect:function(e){this.sId=e.getSource().getId();var t="",n="";if(this.sId.indexOf("accountDetails")!==-1||this.sId.indexOf("idAccountNo")!==-1){var o=new sap.ui.model.Filter("deleted",a.EQ,false);t="Account Search";this.getCustomerPopup();var i="Account Search";var r=new sap.ui.model.Sorter({path:"value",descending:false});this.searchPopup.setTitle(i);this.searchPopup.bindAggregation("items",{path:"local>/accountSet",filters:[o],sorter:r,template:new sap.m.DisplayListItem({label:"{local>value}",value:"{local>key}"})})}},onVerifyRating:function(e){var t=this;var n=e.getParameter("value");var a=e.getSource().getParent().getBindingContextPath();var o=e.getSource().getParent().getModel("viewModel").getProperty(a+"/id");$.post("/ChartedValidRating",{id:o,ChartedValid:n}).done(function(e,t){l.show("Rating "+e)}).fail(function(e,t,n){r.error("Error in Rating")})},onClearInvoice:function(e){var t=this;var n=this.getView().byId("idRegDate").getValue();var a=this.getView().getModel("local").getProperty("/CurrentUser");if(!this.oApproveDialog){this.oApproveDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:"Confirm",content:new sap.m.Text({text:"Do you want to clear Invoice History of start range month ?"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Reject,text:"Submit",press:function(){$.post("/clearInvoiceHistory",{StartDate:n,UserId:a}).done(function(e,n){setTimeout(()=>{t.onStartDate();r.success("Invoice Entries Cleared")},2e3)}).fail(function(e,t,n){r.error("Error in access")});this.oApproveDialog.close()}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this.oApproveDialog.close()}.bind(this)})})}this.oApproveDialog.open()},onDownloadExel:function(e){var t=this;var n=this.getView().getModel("local").getProperty("/GSTInvoices/AccountNo");var a=this.getView().byId("idRegDate").getValue();var o=this.getView().byId("idRegDateTo").getValue();$.ajax({type:"GET",url:"getExcelForGST",data:{AccountNo:n,StartDate:a,EndDate:o},success:function(e){sap.m.MessageToast.show("File Downloaded succesfully")},error:function(e,t,n){sap.m.MessageToast.show("error in downloading the excel file")}})},onCopyEmail:function(){if(!this.missingAddressEmails){l.show("No record with missing address");return}var e="Hello Team,\n\nThe following entries made by you has missing addess for the students, kindly check below and maintain the addess asap.\n\n"+this.missingAddressEmails+"\nNote: This is a system generated email, if already done, please ignore.\n"+"\n\nRegards,\nSystem.";const t=document.createElement("textarea");t.value=e;t.setAttribute("readonly","");t.style.position="absolute";t.style.left="-9999px";document.body.appendChild(t);t.select();document.execCommand("copy");document.body.removeChild(t);l.show("Emails Copied");console.log(e)},super:function(e,t,n){var a=this;$.post("/getAmountForAccount",{AccountNo:e,StartDate:t,EndDate:n,PaymentMode:this.payMode}).done(function(e,t){var n=0,o=0,i=0,r=0,l=0,s=0,d=0;a.missingAddressEmails=[];var u=new Map;var c={"5c187036dba2681834ffe305":"sonal","5c187035dba2681834ffe301":"ANubhav","5d947c3dab189706a40faade":"Servers","5dd6a6aea5f9e83c781b7ac0":"shanu","5ea2f01d7854a13c148f18cd":"Manish","5db594b9b06bff3ffcbba53c":"shalu","5dcf9f7183f22e7da0acdfe4":"vaishali","5ecc968586321064989cdc3f":"kajol","5f1331f2e0b8524af830fa20":"shalini","5f4d01c50815a314ec9238d2":"khushbu","60f0f06da1cf875cb8045975\t":"anjali","5d518381f516afc51c793ce0":"Demo"};for(var g=0;g<e.length;g++){e[g].Index=g+1;n=n+e[g].FullAmount;d+=parseFloat(e[g].CGST)+parseFloat(e[g].SGST);if(e[g].Country==="IN"){o+=1}else{i+=1}if(e[g].IsWallet){s+=e[g].SettleAmount;l+=e[g].USDAmount}else{r+=e[g].FullAmount}if(e[g].Address===null||e[g].Address===""||e[g].Address==="null"){if(u.has(c[e[g].CreatedBy]?c[e[g].CreatedBy]:e[g].CreatedBy)){u.get(c[e[g].CreatedBy]?c[e[g].CreatedBy]:e[g].CreatedBy).push(e[g].Email)}else{u.set(c[e[g].CreatedBy]?c[e[g].CreatedBy]:e[g].CreatedBy,[e[g].Email])}}}u.forEach(function(e,t){a.missingAddressEmails+="\n"+t+"("+e.length+")"+"\n"+e.toString()+"\n"});var m=new sap.ui.model.json.JSONModel;m.setData({records:e});var h={TotalBalance:n,TotalIndianEntries:o,TotalForeignersEntries:i,TotalAmountNonPaypal:r,TotalAmountUSDPaypal:l,TotalSettleAmountPaypal:s,TotalGSTAmount:d.toFixed(2)};a.getView().getModel("local").setProperty("/totalProperties",h);a.getView().byId("newtitle").setText("Total Amount : "+n);a.getView().setModel(m,"viewModel")}).fail(function(e,t,n){r.error("Error in access")})}})});